# Робот интрадей торговли на основе Tinkoff Invest Python gRPC client
## Описание
Робот интрадей торговли на Московской бирже с возможность информирования о сделках и результатах торговли в Telegram чат.
Для доступа к Московской бирже робот использует [Tinkoff Invest Python gRPC client](https://github.com/Tinkoff/invest-python).

## Возможности
- Взаимодействие с торговой платформой [Тинькофф Инвестиции](https://www.tinkoff.ru/invest/)
- Интрадей торговля рублевыми акциями на Московской бирже 
- Для каждой акции можно выбрать персональный алгоритм торговли и его настройки
- Информирование о совершении сделок в Telegram чат
- Подведение итогов торгового дня в Telegram чат
- Тестирование идей (алгоритма торговой системы) на исторических данных 

## Начало работы
### Установка библиотек

- [Tinkoff Invest Python gRPC client](https://github.com/Tinkoff/invest-python)
<!-- termynal -->
```
$ pip install tinkoff-investments
```
- [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot)
<!-- termynal -->
```
$ pip install python-telegram-bot --upgrade
```
### Брокерский счет
Открыть брокерский счет став клиентом [Тинькофф Инвестиции](https://www.tinkoff.ru/invest/) и пополнить счет.

Получить новый токен для доступа к API с полными правами.

### Telegram (опиционально)
Зарегестрировать бота через @BotFather.

Создать чат и получить его chat_id любым доступным способом.

Примечание: детальные инструкции есть в интернете. 

### Минимально необходимые настройки робота
1. Открыть settings.ini файл
2. Указать токен доступа в API в поле "TOKEN" раздела "INVEST_API"
3. (Опционально) Указать токен telegram бота в поле "TELEGRAM_BOT_TOKEN" раздела "BLOG"
4. (Опционально) Указать id telegram чата в поле "TELEGRAM_CHAT_ID" раздела "BLOG"

Примечание: Торговый алгоритм доступный в роботе является лишь примером и не является инвестиционной рекомендацией.

### Запуск
Версия python 3.10 (скорее ниже, но тестировалась и работает на 3.10). 

Запуск main.py

## Описание конфигурации
Вся конфигурация находиться в settings.ini файле.
### Раздел GENERAL
- mode - режим работы робота: 0 - тестирование алгоритма на исторических свечах, 2 - реальная интрадей торговля. (1 - режим торговли SandBox будет реализован в будущем)
### Раздел INVEST_API
Токен и имя приложения для API доступа к [Тинькофф Инвестиции](https://www.tinkoff.ru/invest/).
### Раздел BLOG
- status - режим работы информирования о сделках в telegram: 0 - отключено, 1 - включено
- токен бота и chat id для постов в telegram
### Раздел TRADING_ACCOUNT
Минимальные пороги по размеру средств (rub) для аккаунта в [Тинькофф Инвестиции](https://www.tinkoff.ru/invest/) для начала торговли. Если подходяших аккаунтов нет, то торговля не начинается.
### Раздел TRADING_SETTINGS
Настройки временных интервалов для проведения торговли. Торговля ведется только в основную торговую сессию.
### Раздел Стратегий
Настройки стратегий торговли акциями. 

Раздел STRATEGY_имя_тикера:

- STRATEGY_NAME - имя алгоритма используемого для торговли акцией.
- TICKER - имя тикера, используется для telegram сообщений (human-friendly именование акции)
- FIGI - figi акции. Необходимо для API.
- MAX_LOTS_PER_ORDER - максимальное колличество лотов на одно торговое поручение. Расчет колличества лотов происходит исходя из колличества доступных средств.

Раздел STRATEGY_имя_тикера_SETTINGS:

Указываем детальные настройки алгоритма. Список настроек не типизирован и может меняться от алгоритма (поле STRATEGY_NAME)

Примечание: Есть ограничение: одна акция - одна стратегия.

Раздел TEST_STRATEGY и TEST_STRATEGY_SETTINGS

Отдельные настройки алгоритма для тестирования на исторических свечах.   

## Режим тестирования алгоритма
В режиме тестирования алгоритма происходит тестирование алгоритма по настройкам из раздела TEST_STRATEGY и TEST_STRATEGY_SETTINGS.

Тестирование проиходит на исторических свечах (интеравал 1 минута) за последние 7 дней:
- Алгоритмом обрабатываются свечи пока не поступает сигнал на Long или Short. 
- После получения сигнала, последующие свечи используются для определения судьбы сигнала: отработка take profit или stop loss.
- После отработки сигнала, алгоритм ишет следующий сигнал и так по кругу.
- По итогу, генерируется отчет (записи в лог) о результатах работы: сколько было сигналов, сколько сигналов отработано по take profit и stop loss. 
- На основе этих данных, принимается решение об изменении алгоритма и\или его настроек.   

## Режим торговли на бирже
Режим реальной торговли на Московской бирже.

Перед началом торгов:
- Верифицирутеся токен
- Определяется подходящий аккаунт для торгов 
- Считывается расписание торгов и выбирается время начала торгов (начало основной сессии)

Торги:
- Проверяются акции на возможность торговли (список стратегий из конфигурации)
- Наличие средств для торговли (rub)
- Подключается stream на свечи по акциям
- По свечам отрабатывают алгоритмы и подают сигналы 
- Сигналы обрабатываются открытием позиции
- При достижении уровней take profit и stop loss, позиции закрываются
- Важно: робот интрадей торговли. Поэтому перед началом и после окончания торговли. Будут отменены все ордера и закрыты все позиции (аккаунт будет приведен в состояние только деньги на счете).

Расписание торгов:
- Робот взаимодействует с расписанием торгов
- Ожидает торгового дня и его окончания
- Запускает торговлю каждый торговый день и пропускает не торговые
- Не требует перезапуска между торговыми днями
- После запуска в режиме торгов, робот работает в режим постоянной торговли и требует вмешательство человека только в особых ситуациях. 

## Добавление своего алгоритма
- Написать свой класс инкапсулирующий новый торговый алгоритм на основе свечей интервала 1 минута  
- Класс должен быть наследником IStrategy 
- Придумать "имя классу"
- Прописать его создание в StrategyFactory
- Создать конфигурацию в settings.ini указав "имя класса" в поле STRATEGY_NAME
- Для гибкости, настройки алгоритма не типизируемы (раздел STRATEGY_имя_тикера_SETTINGS) и разбираются из dict в самом классе.
- Проверить и улучшить новый алгоритм в режиме тестирования на исторических свечах

## Сообщения в telegram
- Информирует о начале торгового дня и списке доступных к торговле акций
- Информирует об открытии позиции с уровнями take profit и stop loss
- Информирует о закрытии позиции
- Информирает об окончании торгов 
- Подводит результаты торговой сессии и итоговой доходности за день

Информация в telegram опциональна и лишь улучшает информирование о работе работа.

## Логирование
Все логи пишуться в logs/robot.log.
Уровень логирования и другие настройки при необходимости можно поменять в main.py

## В будущих версиях 
- Режим торговли SandBox (стоит отметить, что с режимом тестирования на исторических свечах, необходимость такого режима не велика)
- Выставление stop ордеров. Стоп ордера не рекомендуются в документации, но точность и скорость их выполнения заметно выше.
- Добавление поддержки алгоритмов: "по стакану", "по исполненым ордерам"
- Добавление асинхронности. В первую очередь для сообщений в telegram, invest-api работает значительно шустрее.
- Доработка на запуск в Docker
- Добавление retry попыток для запросов в API на сетевые ошибки.
По личным наблюдениям ошибки сети приходят от API как RequestError без возможности точной идентификации, что ошибка именно сетевая. 
Например: RequestError(<StatusCode.UNAVAILABLE: (14, 'unavailable')>, 'DNS resolution failed for invest-public-api.tinkoff.ru: UNAVAILABLE: OS Error', None) details=DNS resolution failed for invest-public-api.tinkoff.ru: UNAVAILABLE: OS Error